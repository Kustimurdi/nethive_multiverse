
```{julia}
include("/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/2d_bees_analysis/2d_analysis_src/load_data.jl")
include("/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/2d_bees_analysis/2d_analysis_src/analyse.jl")
include("/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/2d_bees_analysis/2d_analysis_src/visualize.jl")
```

```{julia}
using GLMakie
using Statistics
#using CairoMakie
GLMakie.activate!()
```

```{julia}
#folder_path = "/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/multi_task_simulations/2tasks_2bees_sanity_check_sweep"
#folder_path = "/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/multi_task_simulations/one_task_sanity_check_sweep"
#folder_path = "/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/multi_task_simulations/10t10b_standard_prefactor_difference"
folder_path = "/scratch/n/N.Pfaffenzeller/nikolas_nethive/nethive_queen_gene_vector/multi_task_simulations/10t10b_standard_prefactor_adding_b1_other_tasks"
data_path = joinpath(folder_path, "data")
```

```{julia}
run_paths = readdir(data_path, join=true)
processed_data = load_processed_runs(run_paths)
```

```{julia}
#one_run = prepare_one_run(processed_data[1])
heatmap_data = prepare_heatmap_data(processed_data)
```

```{julia}
# Calculate averages across replications
averaged_results = combine(groupby(heatmap_data, [:lambda_sensitivity, :interaction_rate]),
                          :score => mean => :score_mean,
                          :max_overlap => mean => :max_overlap_mean,  # Boolean â†’ fraction
                          :seed => (x -> length(unique(x))) => :n_replications,
                          nrow => :n_rows)

# View results
println(averaged_results)
```

```{julia}
x_vals = sort(unique(averaged_results.interaction_rate))
y_vals = sort(unique(averaged_results.lambda_sensitivity))

deleteat!(x_vals, 1)
deleteat!(y_vals, 1)

heatmap_matrix = [begin
    row = (averaged_results.interaction_rate .== x) .& (averaged_results.lambda_sensitivity .== y)
    if any(row)
        #println("Found $(sum(row)) matching rows")
        averaged_results.score_mean[row][1]  # Use the boolean index to filter, then take first match
    else
        NaN  # or 0, if you prefer
    end
end for y in y_vals, x in x_vals]

push!(x_vals, maximum(x_vals) * 10)
push!(y_vals, maximum(y_vals) * 10)
```

```{julia}
n_runs = averaged_results.n_rows[1]
f = Figure()
ax = Axis(f[1, 1], xlabel="Interaction Rate [1/s]", ylabel="Lambda Sensitivity", title="Total score S averaged over $(n_runs) runs",
        xscale=log10, yscale=log10)
hm = heatmap!(ax, x_vals, y_vals, heatmap_matrix')
Colorbar(f[1,2], hm)

#scatter!(ax, [(x, y) for x in x_vals for y in y_vals], color=:white, strokecolor=:black, strokewidth=1)
f
```

```{julia}
save_path = joinpath(folder_path, "plots")
if !isdir(save_path)
    mkdir(save_path)
end
save(joinpath(save_path, "score_heatmap.svg"), f)
save(joinpath(save_path, "score_heatmap.pdf"), f)
println(joinpath(save_path, "score_heatmap.svg"))
```

```{julia}
x_vals = sort(unique(averaged_results.interaction_rate))
y_vals = sort(unique(averaged_results.lambda_sensitivity))

deleteat!(x_vals, 1)
deleteat!(y_vals, 1)

id_heatmap_matrix = [begin
    row = (averaged_results.interaction_rate .== x) .& (averaged_results.lambda_sensitivity .== y)
    if any(row)
        averaged_results.max_overlap_mean[row][1]
    else
        NaN  # or 0, if you prefer
    end
end for y in y_vals, x in x_vals]


push!(x_vals, maximum(x_vals) * 10)
push!(y_vals, maximum(y_vals) * 10)
```

```{julia}
id_f = Figure()
id_ax = Axis(id_f[1, 1], xlabel="Interaction Rate [1/s]", ylabel="Lambda Sensitivity", title="Max overlap of leading NNs over $(n_runs) runs",
        xscale=log10, yscale=log10)
hm = heatmap!(id_ax, x_vals, y_vals, id_heatmap_matrix')
Colorbar(id_f[1,2], hm)

#scatter!(ax, [(x, y) for x in x_vals for y in y_vals], color=:white, strokecolor=:black, strokewidth=1)
id_f
```

```{julia}
save_path = joinpath(folder_path, "plots")
if !isdir(save_path)
    mkdir(save_path)
end
save(joinpath(save_path, "sum_id_same.svg"), id_f)
save(joinpath(save_path, "sum_id_same.pdf"), id_f)
```
